<!DOCTYPE html>
<html>
  <head>
    <%- include('../partials/head') %>
    <link rel="stylesheet" href="/css/article/create.css">
    <title>Create Article</title>

  <style>
    .preview  {
      max-width: 850px;
      margin: 3rem auto;
      padding: 0 1rem;
    }

    /* --- Article Header --- */
    .article-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .article-header h1 {
      font-size: 2.2rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    .author-details {
      font-size: 0.95rem;
      color: #aaa;
    }

    .author-details span {
      font-weight: 600;
      color: #ddd;
    }

    .article-cover {
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      width: 100%;            /* take full width */
      max-width: 800px;       /* but don’t exceed desktop design */
      aspect-ratio: 16/9;     /* keep 16:9 ratio automatically */
      margin: 2rem auto;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .article-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;      /* crop nicely if aspect doesn’t match */
      border-radius: 8px;
    }

    /* --- Article Body --- */
    .article-body {
      font-size: 1.1rem;
      line-height: 1.7;
      color: #ddd;
    }

    .article-body pre {
      background: #1e1e1e;
      padding: 1rem;
      border-radius: 6px;
      overflow-x: auto;
    }

    /* --- All Images inside article body (Quill editor output) --- */
    .article-body img,
    .ql-editor img {
      display: block;
      max-width: 100%;
      height: auto;
      margin: 1.5rem auto;
      border-radius: 6px;
      object-fit: contain;       /* show whole image */
    }

    /* --- Mobile adjustments --- */
    @media (max-width: 576px) {
      .article-header h1 {
        font-size: 1.6rem;
      }
      .author-details {
        font-size: 0.85rem;
      }
    }
  </style>

  </head>

  <body class="bg-dark text-white">
    <%- include('../partials/nav') %>

    <main class="container py-4">

      <form action="/articles?articleId=<%= articleId %>" method="POST" enctype="multipart/form-data" id="articleForm">
        
        <div class="btn-body d-flex justify-content-between mb-3">
          <h1>Create Article</h1>
          <div class="d-flex gap-2">
            <button id="previewButton" type="button" class=" btn btn-secondary">Preview</button>
            <button class="btn btn-primary" type="submit">Publish</button>
          </div>
        </div>

        <!-- detail section -->
        <div class="row g-3 mb-3" id="details-section">
          <!-- title -->
          <div class="col-12 col-lg-7">
            <label class="form-label" for="title-input-field">Title</label>
            <input class="form-control border-0 rounded-0" placeholder="Enter Your Title..." type="text" name="title" id="title-input-field" required>
          </div>

          <!-- reading time -->
          <div class="col-12 col-lg-2">
            <label class="form-label" for="reading-time-input-field">Time Duration</label>
            <input class="form-control border-0 rounded-0" placeholder="Reading Time?" type="number" name="readingTimeMin" id="reading-time-input-field" required>
          </div>

          <!-- cover image -->
          <div class="col-12 col-lg-3">
            <label class="form-label" for="cover-Image-URL">Cover Image</label>
            <input class="form-control border-0 rounded-0" type="file" name="coverImageURL" id="cover-Image-URL" required />
          </div>
        </div>

        <!-- body -->
        <div class="mb-3">
          
          <label class="form-label" for="article-body">Body</label>
          
          <div class="bg-light text-black" style="font-size: large;" id="article-body">

            <!-- quill editor -->
            <div id="editor" style="font-size: large;"></div>

            <!-- Hidden fields -->
            <input type="hidden" name="content_html" id="content_html">
            <input type="hidden" name="content_delta" id="content_delta">
            <input type="hidden" name="articleId" id="articleId" value="<%= articleId%>">
            

            <!-- preview section -->
            <div class="bg-dark">
              <article id="previewArea" class="hidden preview bg-dark text-white">
                <!-- Header -->
                <div class="article-header text-center">

                  <h1 id="preview-title"></h1>

                  <div class="author-details d-flex justify-content-center gap-3 flex-wrap">

                    <p><span>Author:</span> <%= user?.fullname || 'You' %></p>
                    <span>•</span>
                    <p id="preview-date"></p>
                    <span>•</span>
                    <p><span id="preview-reading-time"></span> min read</p>

                  </div>

                </div>

                <!-- Cover Image -->
                <div class="article-cover mt-3">
                  <img id="preview-cover" src="" alt="Cover Image">
                </div>

                <!-- Content -->
                <div class="article-body mt-3 ql-editor" id="preview-content"></div>
              </article>
            </div>


          </div>
        </div>

      </form>
    </main>


    <!-- scripts -->
    <%- include('../partials/scripts')%>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        /* variables */
        // quill variables
        const ql_toolbar = document.getElementsByClassName('ql-toolbar');
        const editor = document.getElementById('editor'); 

        const previewArea = document.getElementById('previewArea'); 
        const articleId = document.getElementById('articleId').value;
        // detail section variables
        const detailSection = document.getElementById('details-section');
        const titleInput = document.getElementById('title-input-field');
        const readingTimeInput = document.getElementById('reading-time-input-field');
        const coverImageURL = document.getElementById('cover-Image-URL');




        /* quill.js */
        // Register custom fonts
        const Font = Quill.import('formats/font');
        Font.whitelist = ['sans-serif','serif','monospace','roboto','inconsolata','times-new-roman'];
        Quill.register(Font, true);

        // Custom image handler
        function imageHandler() {
          const input = document.createElement('input');
          input.setAttribute('type', 'file');
          input.setAttribute('accept', 'image/*');
          input.click();

          input.onchange = async () => {
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('image', file);

            const res = await fetch(`/articles/${articleId}/upload-image`, {
              method: 'POST',
              body: formData
            });

            const data = await res.json();
            if (data.url) {
              const range = quill.getSelection();
              quill.insertEmbed(range.index, 'image', data.url);
            }
          };
        }

        // Init Quill
        const quill = new Quill('#editor', {
          theme: 'snow',
          modules: {
            syntax: true,
            toolbar: {
              container: [
                [{ font: ['sans-serif','serif','monospace','roboto','inconsolata','times-new-roman'] }],
                [{ header: [1, 2, 3, false] }],
                ['bold','italic','underline','strike'],
                [{ list: 'ordered' }, { list: 'bullet' }],
                ['blockquote','code-block'],
                ['link','image'],
                ['clean']
              ],
              handlers: { image: imageHandler }
            }
          },
          placeholder: 'Write your article here…'
        });

        // On submit
        document.getElementById('articleForm').addEventListener('submit', function () {
          document.getElementById('content_html').value = quill.root.innerHTML;
       
          const delta = quill.getContents() || {};
          document.getElementById('content_delta').value = JSON.stringify(delta);
        });




        /* preview area */
        // Preview toggle
        document.getElementById('previewButton').addEventListener('click', function () {
          // toggle hidden
          detailSection.classList.toggle('hidden');
          ql_toolbar[0].classList.toggle('hidden');
          editor.classList.toggle('hidden');
          previewArea.classList.toggle('hidden');

          // fill preview
          document.getElementById('preview-title').innerText = titleInput.value || 'Untitled';
          document.getElementById('preview-date').innerText = new Date().toLocaleDateString("en-US", { 
            weekday: "short", 
            year: "numeric", 
            month: "short", 
            day: "numeric" 
          });
          document.getElementById('preview-reading-time').innerText = readingTimeInput.value || '—';

          // show cover image if selected
          if (coverImageURL.files && coverImageURL.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
              document.getElementById('preview-cover').src = e.target.result;
            };
            reader.readAsDataURL(coverImageURL.files[0]);
          }

          // set article body
          document.getElementById('preview-content').innerHTML = quill.root.innerHTML;
        });




        if (window.hljs) hljs.highlightAll();

      });


    </script>
  </body>
</html>
